<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Vehicular LSAF</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #1e1e2f; color: #fff; margin:0; padding:0;}
        .hidden { display: none; }
        .access-section, .container { display:flex; justify-content:center; align-items:center; min-height:100vh; }
        .access-container { text-align:center; background: #2b2b3f; padding: 30px; border-radius: 10px; }
        input { padding:10px; border-radius:5px; border:none; width: 250px; margin:5px 0;}
        button { padding:10px 20px; border:none; border-radius:5px; background:#4caf50; color:#fff; cursor:pointer;}
        button:disabled { background:#999; cursor:not-allowed;}
        .message { margin: 15px 0; padding: 10px; border-radius: 5px; display: none;}
        .message.success { background: rgba(0,200,0,0.5);}
        .message.error { background: rgba(200,0,0,0.5);}
        .form-container { background:#2b2b3f; padding:20px; border-radius:10px; width:90%; max-width:700px;}
        .two-columns { display:flex; gap:10px;}
        .form-group { flex:1; display:flex; flex-direction:column; margin-bottom:10px;}
        label.required::after { content:" *"; color:red;}
    </style>
</head>
<body>

    <!-- SECCIÓN DE ACCESO -->
    <div id="accessSection" class="access-section">
        <div class="access-container">
            <h2><i class="fas fa-lock"></i> Sistema de Registro LSAF</h2>
            <p>Este formulario requiere un código de acceso válido</p>
            <input type="password" id="passwordInput" placeholder="Ingrese la contraseña">
            <button onclick="checkAccess()"><i class="fas fa-unlock"></i> Verificar Acceso</button>
            <p id="accessError" class="message error">Código incorrecto o ya utilizado</p>
        </div>
    </div>

    <!-- FORMULARIO -->
    <div id="formContent" class="container hidden">
        <div class="form-container">
            <h1>Registro Vehicular LSAF</h1>
            <div id="message" class="message success"></div>
            <form id="vehicleForm">
                <div class="form-group">
                    <label for="nombre" class="required">Nombre y Apellido</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>
                <div class="form-group">
                    <label for="nuim" class="required">NUIM</label>
                    <input type="text" id="nuim" name="nuim" required>
                </div>
                <div class="form-group">
                    <label for="telefono" class="required">Número de Teléfono</label>
                    <input type="tel" id="telefono" name="telefono" required>
                </div>
                <div class="form-group">
                    <label for="marca" class="required">Marca del Vehículo</label>
                    <input type="text" id="marca" name="marca" required>
                </div>
                <div class="form-group">
                    <label for="modelo" class="required">Modelo del Vehículo</label>
                    <input type="text" id="modelo" name="modelo" required>
                </div>
                <div class="form-group">
                    <label for="color" class="required">Color del Vehículo</label>
                    <input type="text" id="color" name="color" required>
                </div>
                <div class="form-group">
                    <label for="matricula" class="required">Matrícula del Vehículo</label>
                    <input type="text" id="matricula" name="matricula" required>
                </div>
                <button type="submit" id="submitBtn"><i class="fas fa-paper-plane"></i> Registrar Vehículo</button>
            </form>
        </div>
    </div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwuZVRDOgShaXoDpfNKEG6UvO9FQ_Uh0ULlV9XOvntESC_hR0Xslz-yadDb-CkRolR_/exec";

    // Verificar contraseña
    async function checkAccess() {
        const input = document.getElementById('passwordInput').value.trim();
        if (!input) return;

        try {
            const res = await fetch(`${WEB_APP_URL}?t=${Date.now()}`);
            const data = await res.json(); // { currentCode: "CB8366" }
            console.log("Código actual recibido:", data.currentCode);
            if (input === data.currentCode) {
                document.getElementById('accessSection').classList.add('hidden');
                document.getElementById('formContent').classList.remove('hidden');
                document.getElementById('accessError').style.display = 'none';
            } else {
                document.getElementById('accessError').style.display = 'block';
            }
        } catch (err) {
            console.error("Error obteniendo código:", err);
        }
    }

    // Enviar formulario
    document.getElementById('vehicleForm').addEventListener('submit', async function(e){
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Cargando...";

        const formData = {
            nombre: document.getElementById('nombre').value,
            nuim: document.getElementById('nuim').value,
            telefono: document.getElementById('telefono').value,
            marca: document.getElementById('marca').value,
            modelo: document.getElementById('modelo').value,
            color: document.getElementById('color').value,
            matricula: document.getElementById('matricula').value
        };

        try {
            const res = await fetch(`${WEB_APP_URL}?action=submit`, {
                method: 'POST',
                body: JSON.stringify(formData),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            console.log("Respuesta del Web App:", data);

            if (data.success) {
                document.getElementById('message').innerText = "Registro enviado correctamente!";
                document.getElementById('message').className = "message success";
                document.getElementById('vehicleForm').reset();
            } else {
                document.getElementById('message').innerText = "Error al enviar registro.";
                document.getElementById('message').className = "message error";
            }
        } catch(err) {
            console.error("Error enviando datos:", err);
            document.getElementById('message').innerText = "Error al enviar registro.";
            document.getElementById('message').className = "message error";
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Registrar Vehículo';
        }
    });
</script>

</body>
</html>
